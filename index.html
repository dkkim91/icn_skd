<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>인천공항 출도착 스케줄</title>
  <style>
    body { font-family: 'Malgun Gothic', Arial, sans-serif; margin: 0; background: #f9f9f9; }
    .container { max-width: 1100px; margin: 18px auto; background: #fff; border-radius: 18px; box-shadow: 0 2px 16px #bbb; padding: 18px; }
    h2 { text-align: center; margin-bottom: 14px; color: #2563eb; letter-spacing:-1px;}
    .info { text-align: center; font-size: 1.02em; color: #333; margin-bottom: 10px; }
    .filters { display: flex; flex-wrap: wrap; gap: 8px; margin: 8px 0 16px 0; justify-content: center;}
    .filters label { font-size:1.02em; margin-right:5px; }
    .filters input, .filters select { padding:4px 10px; font-size:1em; border:1px solid #ccc; border-radius: 5px; }
    .filters .btn { background:#2563eb; color:#fff; border:none; padding:4px 14px; border-radius:6px; cursor:pointer;}
    table { width:100%; border-collapse:collapse; margin-top: 6px; }
    th,td { padding:6px 3px; border-bottom:1px solid #e2e2e2; font-size:0.99em; text-align:center;}
    th { background:#f2f5fa; color:#2563eb; }
    tr:nth-child(even) { background:#f9fbff; }
    #rowCount { font-weight:bold; margin:10px 0 0 2px; text-align:right;}
    #refreshBtn { margin-left:10px; background:#e1e8ff; color:#222; border:1px solid #7ca5ea; border-radius:6px; padding:3px 9px; cursor:pointer; }
    @media (max-width:900px) {
      .container { padding:8px;}
      table, thead, tbody, th, td, tr { font-size:0.95em; }
      #rowCount { text-align:center;}
      .filters { flex-direction:column; align-items:center;}
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>인천공항 출도착 스케줄</h2>
    <div class="info" id="info-date">
      출발일: <span id="date"></span> /
      갱신시각: <span id="updated_at"></span>
      <button id="refreshBtn" title="API에서 최신 정보 새로고침">⟳ 전체조회</button>
    </div>
    <form class="filters" id="filters">
      <label>출발일
        <select id="dateSelect"></select>
      </label>
      <label>KAL/OAL
        <select id="kal_oal">
          <option value="">전체</option>
          <option value="KAL">KAL</option>
          <option value="OAL">OAL</option>
        </select>
      </label>
      <label>항공사
        <input type="text" id="airlineCodeFilter" placeholder="예: KE" size="4" />
      </label>
      <label>편명
        <input type="text" id="flightId" placeholder="예: KE123" />
      </label>
      <label>구간
        <input type="text" id="sector" placeholder="예: ICN/NRT" />
      </label>
      <label>출도착
        <select id="op_type">
          <option value="">전체</option>
          <option value="출발">출발</option>
          <option value="도착">도착</option>
        </select>
      </label>
      <label>상태
        <select id="status">
          <option value="">전체</option>
          <option value="정시">정시</option>
          <option value="지연">지연</option>
          <option value="조기">조기</option>
        </select>
      </label>
      <label>터미널
        <select id="terminalId">
          <option value="">전체</option>
        </select>
      </label>
      <label>게이트
        <input type="text" id="gateNumberFilter" size="2" />
      </label>
      <label>Carousel
        <input type="text" id="carouselFilter" size="2" />
      </label>
      <label>Exit
        <input type="text" id="exitNumberFilter" size="2" />
      </label>
      <button class="btn" type="submit">검색</button>
    </form>
    <div id="rowCount"></div>
    <div style="overflow-x:auto;">
      <table id="skd-table">
        <thead>
          <tr>
            <th>출발일</th>
            <th>KAL/OAL</th>
            <th>편명</th>
            <th>구간</th>
            <th>출도착</th>
            <th>예정시간</th>
            <th>실제시간</th>
            <th>상태</th>
            <th>터미널</th>
            <th>게이트</th>
            <th>기종</th>
            <th>Carousel</th>
            <th>Exit</th>
          </tr>
        </thead>
        <tbody id="skd-tbody">
          <tr><td colspan="13">데이터를 불러오는 중...</td></tr>
        </tbody>
      </table>
    </div>
  </div>
  <script>
    const SHEET_JSON_URL = "https://script.google.com/macros/s/AKfycbwLdDd2AtP6eEM3BDM1aN9p_Gc0J9oetcM8-VI7BEb6oBe2ufwRiACbV1u5eTWniZjQiw/exec";
    let SKD_DATA = [];

    // --- 시간 변환 함수 (UTC ISO 문자열을 브라우저의 로컬 시간대(KST)로 변환) ---
    function toKSTString(dtstr) {
      if (!dtstr) {
        return "";
      }

      try {
        // ISO 8601 문자열 (예: "...Z")은 Date 객체에서 UTC로 파싱 후 브라우저의 로컬 시간으로 자동 변환됩니다.
        const dateObj = new Date(dtstr); 
        
        // Date 객체가 유효하고, 원본 문자열이 ISO UTC 형식인지 확인 (Z로 끝나는지)
        if (!isNaN(dateObj.getTime()) && dtstr.endsWith('Z')) {
          // Date 객체의 로컬 시간 구성 요소를 사용하여 KST 문자열 생성
          const yyyy = dateObj.getFullYear();
          const MM = String(dateObj.getMonth() + 1).padStart(2, '0');
          const dd = String(dateObj.getDate()).padStart(2, '0');
          const HH = String(dateObj.getHours()).padStart(2, '0');
          const mm = String(dateObj.getMinutes()).padStart(2, '0');
          const ss = String(dateObj.getSeconds()).padStart(2, '0');
          
          return `${yyyy}-${MM}-${dd} ${HH}:${mm}:${ss}`;
        }
      } catch (e) {
        console.error("Date parsing error:", e); // 날짜 파싱 중 오류 발생 시 콘솔에 기록
      }

      // ISO UTC 형식이 아니거나 파싱에 실패한 경우, 이미 'YYYY-MM-DD HH:mm:ss' 형식인지 확인
      const kstFormatRegex = /^\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}$/;
      if (kstFormatRegex.test(dtstr)) {
        return dtstr;
      }

      return dtstr; // 그 외의 경우 원본 문자열 반환
    }

    // --- 시간 변환 함수 (UTC ISO 문자열을 HH:mm 형식으로 변환) ---
    function toHHMMString(dtstr) {
      if (!dtstr) {
        return "";
      }
      try {
        const dateObj = new Date(dtstr);
        if (!isNaN(dateObj.getTime())) {
          const HH = String(dateObj.getHours()).padStart(2, '0');
          const mm = String(dateObj.getMinutes()).padStart(2, '0');
          return `${HH}:${mm}`;
        }
      } catch (e) {
        console.error("Time parsing error for HH:mm:", e);
      }
      return ""; // 파싱 실패 시 빈 문자열 반환
    }
    // --- 시간 변환 함수 끝 ---

    async function loadDataAndRender() {
      document.getElementById("skd-tbody").innerHTML = `<tr><td colspan="13">데이터를 불러오는 중...</td></tr>`;
      try {
        let res = await fetch(SHEET_JSON_URL + "?" + Date.now());
        SKD_DATA = await res.json();

        // 출발일 옵션 동적생성 (오늘/내일만)
        let dates = [...new Set(SKD_DATA.map(row=>row.date))].sort();
        let todayStr = (new Date()).toISOString().slice(0,10).replace(/-/g,"");
        let tomorrowStr = (function(d){ d.setDate(d.getDate()+1); return d.toISOString().slice(0,10).replace(/-/g,""); })(new Date());
        let dateSelect = document.getElementById("dateSelect");
        dateSelect.innerHTML = `<option value="">전체</option>` +
          (dates.includes(todayStr) ? `<option value="${todayStr}">${todayStr}</option>` : "") +
          (dates.includes(tomorrowStr) ? `<option value="${tomorrowStr}">${tomorrowStr}</option>` : "");
        dateSelect.value = "";

        // 터미널 옵션 동적생성
        let terminalSelect = document.getElementById("terminalId");
        let terminals = [...new Set(SKD_DATA.map(row => row.terminalId).filter(t => t))].sort();
        terminalSelect.innerHTML = `<option value="">전체</option>` + 
                                   terminals.map(t => `<option value="${t}">${t}</option>`).join('');
        terminalSelect.value = "";


        renderTable();
        document.getElementById("date").innerText = (dates[0] || "");

        // 최신 updated_at 구하기
        let latestUpdatedAt = "";
        if (SKD_DATA.length > 0) {
          let sorted = SKD_DATA
            .filter(r => r.updated_at)
            .sort((a, b) => (a.updated_at < b.updated_at ? 1 : -1));
          latestUpdatedAt = sorted.length > 0 ? sorted[0].updated_at : "";
        }
        
        // KST로 변환하여 표시
        document.getElementById("updated_at").innerText = toKSTString(latestUpdatedAt) || "-";

      } catch(e) {
        document.getElementById("skd-tbody").innerHTML = `<tr><td colspan="13">데이터 로드 오류</td></tr>`;
        document.getElementById("updated_at").innerText = "- (오류)";
        console.error("데이터 로드 중 오류 발생:", e);
      }
    }

    function renderTable() {
      let tbody = document.getElementById("skd-tbody");
      let f = {};
      // 필터 항목 업데이트: airlineCodeFilter 추가
      ["dateSelect","kal_oal","airlineCodeFilter","flightId","sector","op_type","status","terminalId", "gateNumberFilter", "carouselFilter", "exitNumberFilter"].forEach(id=>{
        f[id] = document.getElementById(id).value.trim();
      });

      let filtered = SKD_DATA.filter(row => {
        if (f.dateSelect && row.date != f.dateSelect) return false;
        if (f.kal_oal && row.kal_oal != f.kal_oal) return false;
        // 항공사 코드 필터링 (편명 앞 2글자)
        if (f.airlineCodeFilter && (!row.flightId || !row.flightId.startsWith(f.airlineCodeFilter.toUpperCase()))) return false;
        if (f.flightId && (!row.flightId || row.flightId.indexOf(f.flightId) === -1)) return false;
        if (f.sector && (!row.sector || row.sector.indexOf(f.sector) === -1)) return false;
        if (f.op_type && row.op_type != f.op_type) return false;
        if (f.status && row.status != f.status) return false;
        if (f.terminalId && row.terminalId != f.terminalId) return false; // 터미널은 정확히 일치해야 함
        if (f.gateNumberFilter && (!row.gateNumber || String(row.gateNumber).indexOf(f.gateNumberFilter) === -1)) return false;
        if (f.carouselFilter && (!row.carousel || String(row.carousel).indexOf(f.carouselFilter) === -1)) return false;
        if (f.exitNumberFilter && (!row.exitNumber || String(row.exitNumber).indexOf(f.exitNumberFilter) === -1)) return false;
        return true;
      });
      document.getElementById("rowCount").innerText = `총 ${filtered.length}건`;
      // colspan을 13으로 업데이트 (기존 9 - 항공사 1 + 예정시간, 실제시간, 기종, Carousel, Exit 5 = 13)
      if (filtered.length === 0) {
        tbody.innerHTML = `<tr><td colspan="13">일치하는 데이터가 없습니다.</td></tr>`;
        return;
      }
      tbody.innerHTML = filtered.map(row=>`
        <tr>
          <td>${row.date||""}</td>
          <td>${row.kal_oal||""}</td>
          <td>${row.flightId||""}</td>
          <td>${row.sector||""}</td>
          <td>${row.op_type||""}</td>
          <td>${toHHMMString(row.s_time)||""}</td> <!-- 예정시간 HH:mm 형식으로 표시 -->
          <td>${toHHMMString(row.e_time)||""}</td> <!-- 실제시간 HH:mm 형식으로 표시 -->
          <td>${row.status||""}</td>
          <td>${row.terminalId||""}</td>
          <td>${row.gateNumber||""}</td>
          <td>${row.aircraftSubtype||""}</td> <!-- 기종 추가 -->
          <td>${row.carousel||""}</td> <!-- Carousel 추가 -->
          <td>${row.exitNumber||""}</td> <!-- Exit 추가 -->
        </tr>
      `).join('');
    }

    document.getElementById("refreshBtn").onclick = function() {
      loadDataAndRender();
    };
    document.getElementById("filters").onsubmit = function(e) {
      e.preventDefault();
      renderTable();
    };

    // 최초 1회 전체조회
    loadDataAndRender();
  </script>
</body>
</html>
