<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>인천공항 출도착 스케줄</title>
  <!-- (스타일 생략) -->
</head>
<body>
  <div class="container">
    <h2>인천공항 출도착 스케줄</h2>
    <div class="info" id="info-date">
      출발일: <span id="date"></span> /
      갱신시각: <span id="updated_at"></span>
      <button id="refreshBtn" title="API에서 최신 정보 새로고침">⟳ 전체조회</button>
    </div>
    <!-- (필터, 테이블 등 생략) -->
  </div>
  <script>
    const SHEET_JSON_URL = "https://script.google.com/macros/s/AKfycbwLdDd2AtP6eEM3BDM1aN9p_Gc0J9oetcM8-VI7BEb6oBe2ufwRiACbV1u5eTWniZjQiw/exec";
    let SKD_DATA = [];

    function toKSTString(dtstr) {
      if (!dtstr) return "";
      if (/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}(?:\.\d+)?Z$/.test(dtstr)) {
        const m = dtstr.match(/^(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2}):(\d{2})/);
        if (m) {
          const utc = Date.UTC(+m[1], +m[2]-1, +m[3], +m[4], +m[5], +m[6]);
          const kst = new Date(utc + 9*60*60*1000);
          const yyyy = kst.getFullYear();
          const MM = String(kst.getMonth()+1).padStart(2, '0');
          const dd = String(kst.getDate()).padStart(2, '0');
          const HH = String(kst.getHours()).padStart(2, '0');
          const mm = String(kst.getMinutes()).padStart(2, '0');
          const ss = String(kst.getSeconds()).padStart(2, '0');
          return `${yyyy}-${MM}-${dd} ${HH}:${mm}:${ss}`;
        }
        return dtstr;
      }
      if (/^\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}$/.test(dtstr)) {
        return dtstr;
      }
      return dtstr;
    }

    async function loadDataAndRender() {
      document.getElementById("skd-tbody").innerHTML = `<tr><td colspan="13">데이터를 불러오는 중...</td></tr>`;
      try {
        let res = await fetch(SHEET_JSON_URL + "?" + Date.now());
        SKD_DATA = await res.json();
        // (필터링/테이블 출력 생략)
        document.getElementById("date").innerText = (SKD_DATA[0]?.date || "");

        // 최신 updated_at 구하고
        let latestUpdatedAt = "";
        if (SKD_DATA.length > 0) {
          let sorted = SKD_DATA
            .filter(r => r.updated_at)
            .sort((a, b) => (a.updated_at < b.updated_at ? 1 : -1));
          latestUpdatedAt = sorted.length > 0 ? sorted[0].updated_at : "";
        }
        // ★ 콘솔로 원본값 찍기!
        console.log("latestUpdatedAt 원본:", latestUpdatedAt);

        // 변환된 값 화면에 출력
        document.getElementById("updated_at").innerText = toKSTString(latestUpdatedAt) || "-";
      } catch(e) {
        document.getElementById("skd-tbody").innerHTML = `<tr><td colspan="13">데이터 로드 오류</td></tr>`;
        document.getElementById("updated_at").innerText = "- (오류)";
      }
    }

    document.getElementById("refreshBtn").onclick = function() {
      loadDataAndRender();
    };
    document.getElementById("filters").onsubmit = function(e) {
      e.preventDefault();
      renderTable();
    };

    // 최초 1회 전체조회
    loadDataAndRender();
  </script>
</body>
</html>
